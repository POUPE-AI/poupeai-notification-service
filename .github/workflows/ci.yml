name: CI/CD - Poupe.AI Notification Service

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  IMAGE_NAME: franciscopaulinoq/poupeai-notification-service
  INFRA_DIR: /home/deploy/poupeai-infra

jobs:
  test:
    name: Run Tests via Docker Compose
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Criar arquivo .env para Teste
        run: |
          echo "APP_NAME=Notification Service CI" >> .env
          echo "API_VERSION=0.0.1-test" >> .env
          echo "DEBUG=True" >> .env
          echo "RABBITMQ_USER=user" >> .env
          echo "RABBITMQ_PASSWORD=password" >> .env
          echo "RABBITMQ_HOST=rabbitmq" >> .env
          echo "RABBITMQ_PORT=5672" >> .env
          echo "RABBITMQ_MAX_RETRIES=3" >> .env
          echo "RABBITMQ_EXCHANGE_MAIN=notification_exchange" >> .env
          echo "RABBITMQ_EXCHANGE_RETRY=notification_exchange.retry" >> .env
          echo "RABBITMQ_EXCHANGE_DLQ=notification_exchange.dlq" >> .env
          echo "RABBITMQ_QUEUE_MAIN=notification_events" >> .env
          echo "RABBITMQ_QUEUE_RETRY=notification_events.retry" >> .env
          echo "RABBITMQ_QUEUE_DLQ=notification_events.dlq" >> .env
          echo "RABBITMQ_ROUTING_KEY=notification.event" >> .env
          # Retry rápido para teste
          echo "RABBITMQ_RETRY_DELAY_MS=100" >> .env
          echo "REDIS_URL=redis://redis:6379/0" >> .env
          echo "MAIL_SERVER=mailhog" >> .env
          echo "MAIL_PORT=1025" >> .env
          echo "MAIL_USERNAME=" >> .env
          echo "MAIL_PASSWORD=" >> .env
          echo "MAIL_FROM=test@poupe.ai" >> .env
          echo "USE_CREDENTIALS=False" >> .env

      - name: Subir Ambiente
        run: |
          docker compose up -d --build --wait

      - name: Aguardar Aplicação (Health Check Manual)
        run: |
          echo "Aguardando a aplicação iniciar na porta 8001..."
          timeout 60s bash -c 'until curl -s http://localhost:8001/api/v1/health | grep "pass"; do echo "Esperando app..."; sleep 2; done'
          echo "Aplicação está pronta!"

      - name: Rodar Testes
        run: |
          docker compose exec -T app pytest tests/ -v

      - name: Logs em caso de falha
        if: failure()
        run: docker compose logs app

      - name: Derrubar Ambiente
        if: always()
        run: docker compose down -v

  build_and_push:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4
      - name: Login no Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build e push da imagem Docker
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.IMAGE_NAME }}:latest

  deploy:
        needs: build_and_push
        runs-on: ubuntu-latest

        steps:
            - name: Deploy para o servidor
              uses: appleboy/ssh-action@v1.0.3
              with:
                host: ${{ secrets.VPS_HOST }}
                username: ${{ secrets.VPS_USER }}
                key: ${{ secrets.VPS_SSH_KEY }}
                script: |
                    set -e

                    echo "--- Login no Docker Hub ---"
                    echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

                    echo "--- Navegando para o diretório de infra ---"
                    cd ${{ env.INFRA_DIR }}

                    echo "--- Atualizando a imagem do serviço --"
                    docker compose -f docker-compose-production.yml pull notification-service

                    echo "--- Recriando o contêiner notification-service ---"
                    docker compose -f docker-compose-production.yml up -d --no-deps notification-service

                    echo "--- Limpando imagens antigas ---"
                    docker image prune -af
